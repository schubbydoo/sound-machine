<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sound Machine Manager</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script>
  <style>
    .audio-row { align-items: center; }
    .is-clickable { cursor: pointer; }
    .channel-badge { margin-left: 0.5rem; }
  </style>
</head>
<body>
<nav class="navbar is-primary" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="/">
      <strong>Sound Machine</strong>
    </a>
  </div>
  <div class="navbar-menu">
    <div class="navbar-start">
      <a class="navbar-item is-active" href="/">Home</a>
      <a class="navbar-item" href="/wifi">Wi-Fi</a>
      <a class="navbar-item" href="/bt">Bluetooth</a>
    </div>
  </div>
</nav>

<section class="section">
  <div class="container">
    
    <!-- Profile Management -->
    <div class="box">
        <h2 class="title is-4">Profile Management</h2>
        
        <!-- Row 1: Profile Selection and Assignment -->
        <div class="level mb-2">
            <div class="level-left">
                <div class="level-item">
                    <div class="field has-addons">
                        <div class="control">
                            <div class="select">
                                <select id="profileSelect" onchange="switchProfile(this.value)">
                                    {% for p in profiles %}
                                    <option value="{{ p.id }}" {% if p.id == active_profile_id %}selected{% endif %}>
                                        {{ p.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="control">
                            <button class="button" onclick="renameProfile()">
                                <span class="icon is-small"><i class="fas fa-edit"></i></span>
                            </button>
                        </div>
                        <div class="control">
                            <button class="button is-danger is-light" onclick="deleteProfile()">
                                <span class="icon is-small"><i class="fas fa-trash"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="level-item">
                    <button class="button is-success is-light" onclick="createProfile()">
                        <span class="icon"><i class="fas fa-plus"></i></span>
                        <span>New Profile</span>
                    </button>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="field has-addons">
                        <div class="control">
                            <a class="button is-static">Assigned Track</a>
                        </div>
                        <div class="control">
                            <div class="select">
                                <select id="channelSelect">
                                    <option value="">Select Track...</option>
                                    {% for i in range(1, 5) %}
                                    <option value="{{ i }}" 
                                        {% if channels.get(i) and channels[i].id == active_profile_id %}selected{% endif %}>
                                        Track {{ i }} {% if channels.get(i) %}({{ channels[i].name }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="control">
                            <button class="button is-link" onclick="assignChannel()">Assign</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Description and Printing -->
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                     <button class="button is-warning is-light" onclick="openInstructionsModal()">
                        <span class="icon"><i class="fas fa-align-left"></i></span>
                        <span>Description</span>
                    </button>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="dropdown is-hoverable is-right">
                        <div class="dropdown-trigger">
                            <button class="button is-info" aria-haspopup="true" aria-controls="dropdown-menu">
                                <span class="icon"><i class="fas fa-print"></i></span>
                                <span>Print</span>
                                <span class="icon is-small"><i class="fas fa-angle-down"></i></span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="dropdown-menu" role="menu">
                            <div class="dropdown-content">
                                <a href="/print_key/{{ active_profile_id }}" target="_blank" class="dropdown-item">
                                    Answer Key (Current)
                                </a>
                                <a href="/print_key/assigned" target="_blank" class="dropdown-item">
                                    Answer Key (All Assigned)
                                </a>
                                <hr class="dropdown-divider">
                                <a href="/print_worksheet/{{ active_profile_id }}" target="_blank" class="dropdown-item">
                                    Worksheet (Current)
                                </a>
                                <a href="/print_worksheet/assigned" target="_blank" class="dropdown-item">
                                    Worksheet (All Assigned)
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="level-item">
                    <a class="button is-primary is-light" href="/print_tracks" target="_blank" title="Print Track Assignments Label">
                        <span class="icon"><i class="fas fa-tags"></i></span>
                        <span>Print Tracks</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Row 3: Description Display -->
        <div id="descriptionDisplay" class="message is-small is-info is-light mt-3" style="display: none;">
            <div class="message-body">
                <strong>Description:</strong> <span id="descText"></span>
            </div>
        </div>
    </div>

    <!-- Bulk Upload -->
    <div class="box">
        <div class="level mb-2">
            <div class="level-left">
                <h2 class="title is-4">Upload Audio</h2>
            </div>
            <div class="level-right">
                <button class="button is-danger is-light is-small" onclick="openFilesModal()">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                    <span>Manage Files</span>
                </button>
            </div>
        </div>
        <form id="uploadForm" onsubmit="return uploadFiles(event)">
            <input type="hidden" name="profile_id" value="{{ active_profile_id }}">
            <div class="field is-horizontal">
                <div class="field-body">
                    <div class="field">
                        <div class="file has-name is-fullwidth">
                            <label class="file-label">
                                <input class="file-input" type="file" name="file" multiple accept=".wav" id="fileInput">
                                <span class="file-cta">
                                    <span class="file-icon"><i class="fas fa-upload"></i></span>
                                    <span class="file-label">Choose files...</span>
                                </span>
                                <span class="file-name" id="fileName">No file chosen</span>
                            </label>
                        </div>
                    </div>
                    <div class="field has-addons">
                        <div class="control">
                            <a class="button is-static">Auto-Assign from Button</a>
                        </div>
                        <div class="control">
                            <input class="input" type="number" name="auto_assign_start" min="1" max="16" placeholder="Optional">
                        </div>
                        <div class="control">
                            <button class="button is-primary" type="submit">Upload</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Button Mappings -->
    <div class="box">
        <h2 class="title is-4">Button Assignments</h2>
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th width="50">#</th>
                        <th>Assigned Audio</th>
                        <th>Description / Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in range(1, 17) %}
                    {% set m = mappings.get(i) %}
                    <tr>
                        <td class="is-vcentered"><strong>{{ i }}</strong></td>
                        <td class="is-vcentered">
                            <div class="select is-fullwidth">
                                <select onchange="assignButton({{ i }}, this.value)">
                                    <option value="">— Unassigned —</option>
                                    {% for f in all_files %}
                                    <option value="{{ f.id }}" {% if m and m.audio_id == f.id %}selected{% endif %}>
                                        {{ f.filename }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </td>
                        <td class="is-vcentered">
                            {% if m %}
                                <div><small><strong>Desc:</strong> {{ m.description or '-' }}</small></div>
                                <div><small><strong>Cat:</strong> {{ m.category or '-' }}</small></div>
                            {% else %}
                                <span class="has-text-grey-light">-</span>
                            {% endif %}
                        </td>
                        <td class="is-vcentered">
                            <div class="buttons are-small">
                                <button class="button is-info is-light" onclick="play({{ i }})" title="Play">
                                    <span class="icon"><i class="fas fa-play"></i></span>
                                </button>
                                {% if m %}
                                <button class="button is-warning is-light" onclick='editMetadata({{ m | tojson }})' title="Edit Metadata">
                                    <span class="icon"><i class="fas fa-tag"></i></span>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

  </div>
</section>

<!-- Metadata Modal -->
<div class="modal" id="metaModal">
  <div class="modal-background" onclick="closeModal()"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Edit Metadata</p>
      <button class="delete" aria-label="close" onclick="closeModal()"></button>
    </header>
    <section class="modal-card-body">
      <input type="hidden" id="metaId">
      <div class="field">
          <label class="label">Filename</label>
          <div class="control"><input class="input" type="text" id="metaFilename" readonly></div>
      </div>
      <div class="field">
          <label class="label">Description (Source)</label>
          <div class="control"><input class="input" type="text" id="metaDesc" placeholder="e.g. Jurassic Park T-Rex"></div>
      </div>
      <div class="field">
          <label class="label">Category</label>
          <div class="control"><input class="input" type="text" id="metaCat" placeholder="e.g. Sci-Fi"></div>
      </div>
      <div class="field">
          <label class="label">Hint</label>
          <div class="control"><input class="input" type="text" id="metaHint" placeholder="e.g. Big Dinosaur"></div>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="saveMetadata()">Save changes</button>
      <button class="button" onclick="closeModal()">Cancel</button>
    </footer>
  </div>
</div>

<!-- Profile Instructions Modal -->
<div class="modal" id="instrModal">
  <div class="modal-background" onclick="closeInstrModal()"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Profile Instructions</p>
      <button class="delete" aria-label="close" onclick="closeInstrModal()"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
          <label class="label">Instructions / Description</label>
          <div class="control">
              <textarea class="textarea" id="profileInstr" placeholder="e.g. Name the song and artist..."></textarea>
          </div>
          <p class="help">These instructions will appear on the printed worksheet.</p>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="saveInstructions()">Save</button>
      <button class="button" onclick="closeInstrModal()">Cancel</button>
    </footer>
  </div>
</div>

<!-- File Management Modal -->
<div class="modal" id="filesModal">
  <div class="modal-background" onclick="closeFilesModal()"></div>
  <div class="modal-card" style="width: 800px; max-width: 95%;">
    <header class="modal-card-head">
      <p class="modal-card-title">Manage Audio Files</p>
      <button class="delete" aria-label="close" onclick="closeFilesModal()"></button>
    </header>
    <section class="modal-card-body">
      <div class="level">
          <div class="level-left">
              <p>Select files to delete permanently.</p>
          </div>
          <div class="level-right">
              <button class="button is-danger" onclick="deleteSelectedFiles()" id="deleteBtn" disabled>
                  <span class="icon"><i class="fas fa-trash"></i></span>
                  <span>Delete Selected</span>
              </button>
          </div>
      </div>
      <div class="table-container" style="max-height: 60vh; overflow-y: auto;">
          <table class="table is-fullwidth is-striped is-hoverable is-narrow">
            <thead>
                <tr>
                    <th width="40"><input type="checkbox" onchange="toggleAllFiles(this)"></th>
                    <th>Filename</th>
                    <th>Path</th>
                </tr>
            </thead>
            <tbody>
                {% for f in all_files %}
                <tr>
                    <td><input type="checkbox" class="file-check" value="{{ f.id }}" onchange="updateDeleteBtn()"></td>
                    <td>{{ f.filename }}</td>
                    <td class="is-size-7">{{ f.filepath }}</td>
                </tr>
                {% endfor %}
            </tbody>
          </table>
      </div>
    </section>
  </div>
</div>

<script>
// File input name update
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.querySelector('#fileInput');
    if (fileInput) {
        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                const fileNameEl = document.querySelector('#fileName');
                if (fileNameEl) {
                    fileNameEl.textContent = fileInput.files.length + ' files selected';
                }
            }
        };
    }
});

function switchProfile(id) {
    window.location.href = '/?profile_id=' + id;
}

async function createProfile() {
    const name = prompt("Enter new profile name:");
    if (!name) return;
    const fd = new FormData();
    fd.append('name', name);
    const res = await fetch('/api/profile/create', {method: 'POST', body: fd});
    const js = await res.json();
    if (js.ok) switchProfile(js.id);
    else alert(js.error);
}

async function renameProfile() {
    const name = prompt("Enter new name for current profile:");
    if (!name) return;
    const fd = new FormData();
    fd.append('id', '{{ active_profile_id }}');
    fd.append('name', name);
    const res = await fetch('/api/profile/rename', {method: 'POST', body: fd});
    const js = await res.json();
    if (js.ok) location.reload();
    else alert(js.error);
}

async function deleteProfile() {
    if (!confirm("Are you sure you want to delete this profile?")) return;
    const fd = new FormData();
    fd.append('id', '{{ active_profile_id }}');
    const res = await fetch('/api/profile/delete', {method: 'POST', body: fd});
    const js = await res.json();
    if (js.ok) window.location.href = '/';
    else alert(js.error);
}

// Profile Instructions
let currentProfileInstructions = '';
{% for p in profiles %}
    {% if p.id == active_profile_id %}
    currentProfileInstructions = {{ p.instructions | tojson or '""' }};
    {% endif %}
{% endfor %}

// Initialize UI
document.addEventListener('DOMContentLoaded', () => {
    if (currentProfileInstructions) {
        document.getElementById('descText').innerText = currentProfileInstructions;
        document.getElementById('descriptionDisplay').style.display = 'block';
    }
});

function openInstructionsModal() {
    document.getElementById('profileInstr').value = currentProfileInstructions || '';
    document.getElementById('instrModal').classList.add('is-active');
}

function closeInstrModal() {
    document.getElementById('instrModal').classList.remove('is-active');
}

async function saveInstructions() {
    const instr = document.getElementById('profileInstr').value;
    const fd = new FormData();
    fd.append('id', '{{ active_profile_id }}');
    fd.append('instructions', instr);
    
    const res = await fetch('/api/profile/update_instructions', {method: 'POST', body: fd});
    if (res.ok) location.reload();
    else alert('Error saving instructions');
}

async function assignChannel() {
    const chn = document.getElementById('channelSelect').value;
    if (!chn) {
        alert("Please select a track first.");
        return;
    }
    const fd = new FormData();
    fd.append('channel', chn);
    fd.append('profile_id', '{{ active_profile_id }}');
    const res = await fetch('/api/channel/assign', {method: 'POST', body: fd});
    const js = await res.json();
    if (js.ok) location.reload();
    else alert(js.error);
}

async function uploadFiles(ev) {
    ev.preventDefault();
    const form = document.getElementById('uploadForm');
    const fd = new FormData(form);
    const btn = form.querySelector('button[type="submit"]');
    btn.classList.add('is-loading');
    
    try {
        const res = await fetch('/upload', {method: 'POST', body: fd});
        const js = await res.json();
        if (js.ok) location.reload();
        else alert(js.error);
    } catch(e) {
        alert("Upload error");
    } finally {
        btn.classList.remove('is-loading');
    }
}

async function assignButton(btnId, audioId) {
    const fd = new FormData();
    fd.append('profile_id', '{{ active_profile_id }}');
    fd.append('button_id', btnId);
    fd.append('audio_id', audioId);
    
    // Optimistic UI update could happen here, but reload is safer for sync
    const res = await fetch('/api/assign', {method: 'POST', body: fd});
    const js = await res.json();
    if (js.ok) location.reload();
    else alert(js.error);
}

async function play(btnId) {
    console.log('Play button clicked:', btnId);
    try {
        // Get the active profile ID from the select dropdown (in case user switched profiles)
        const profileSelect = document.getElementById('profileSelect');
        const profileId = profileSelect ? profileSelect.value : '{{ active_profile_id }}';
        console.log('Using profile_id:', profileId);
        
        if (!profileId) {
            alert('No profile selected. Please select a profile first.');
            return;
        }
        
        // Pass active profile so we test what we see
        const url = `/play/${btnId}?profile_id=${profileId}`;
        console.log('Fetching URL:', url);
        const response = await fetch(url, {method: 'POST'});
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response result:', result);
        
        if (!result.ok) {
            alert(`Error playing button ${btnId}: ${result.error || 'Unknown error'}`);
            console.error('Play error:', result);
        } else {
            console.log('Play successful:', result.filename);
        }
    } catch(e) {
        alert(`Failed to play button ${btnId}: ${e.message}`);
        console.error('Play exception:', e);
    }
}

// Metadata Modal
function editMetadata(data) {
    document.getElementById('metaId').value = data.audio_id;
    document.getElementById('metaFilename').value = data.filename;
    document.getElementById('metaDesc').value = data.description || '';
    document.getElementById('metaCat').value = data.category || '';
    document.getElementById('metaHint').value = data.hint || '';
    document.getElementById('metaModal').classList.add('is-active');
}

function closeModal() {
    document.getElementById('metaModal').classList.remove('is-active');
}

async function saveMetadata() {
    const fd = new FormData();
    fd.append('id', document.getElementById('metaId').value);
    fd.append('description', document.getElementById('metaDesc').value);
    fd.append('category', document.getElementById('metaCat').value);
    fd.append('hint', document.getElementById('metaHint').value);
    
    const res = await fetch('/api/metadata/update', {method: 'POST', body: fd});
    if (res.ok) location.reload();
    else alert('Error saving metadata');
}

// File Management Modal Functions
function openFilesModal() {
    document.getElementById('filesModal').classList.add('is-active');
}

function closeFilesModal() {
    document.getElementById('filesModal').classList.remove('is-active');
}

function toggleAllFiles(source) {
    const checkboxes = document.querySelectorAll('.file-check');
    for(let i=0; i<checkboxes.length; i++) {
        checkboxes[i].checked = source.checked;
    }
    updateDeleteBtn();
}

function updateDeleteBtn() {
    const checkboxes = document.querySelectorAll('.file-check:checked');
    const btn = document.getElementById('deleteBtn');
    if (checkboxes.length > 0) {
        btn.removeAttribute('disabled');
        btn.innerText = `Delete Selected (${checkboxes.length})`;
    } else {
        btn.setAttribute('disabled', 'true');
        btn.innerText = 'Delete Selected';
    }
}

async function deleteSelectedFiles() {
    const checkboxes = document.querySelectorAll('.file-check:checked');
    if (checkboxes.length === 0) return;
    
    if (!confirm(`Are you sure you want to delete ${checkboxes.length} files? This cannot be undone.`)) return;
    
    const ids = [];
    checkboxes.forEach((cb) => ids.push(cb.value));
    
    const btn = document.getElementById('deleteBtn');
    btn.classList.add('is-loading');
    
    try {
        const res = await fetch('/api/audio/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ids: ids})
        });
        const js = await res.json();
        if (js.ok) {
            if (js.errors && js.errors.length > 0) {
                alert("Some files could not be deleted:\n" + js.errors.join("\n"));
            }
            location.reload();
        } else {
            alert(js.error);
        }
    } catch (e) {
        alert("Delete failed: " + e);
    } finally {
        btn.classList.remove('is-loading');
    }
}
</script>
</body>
</html>
