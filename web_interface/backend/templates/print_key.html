<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Answer Key</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        h1 { text-align: center; font-size: 1.5em; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: left; }
        th { background: #eee; }
        
        .page-break { page-break-after: always; }
        .key-container { margin-bottom: 40px; }
        
        /* Grid Layout Styles */
        .grid-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .grid-view .key-container {
            margin-bottom: 20px;
            break-inside: avoid;
            border: 1px solid #eee;
            padding: 10px;
        }
        .grid-view .page-break {
            page-break-after: auto;
        }
        
        /* Button 4x4 Grid Styles */
        .button-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .button-cell {
            border: 1px solid #999;
            border-radius: 8px;
            padding: 10px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: #fdfdfd;
        }
        .button-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            background: #eee;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .button-content {
            font-size: 0.9em;
            word-break: break-word;
        }
        
        @media print {
            .no-print { display: none; }
            .key-container { margin-bottom: 0; }
            .grid-view { display: grid; }
        }
        .controls {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .checkbox-group {
            display: inline-block;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="no-print" style="margin-bottom: 20px;">
        <div class="controls">
            <div style="margin-bottom: 10px;">
                <button onclick="window.print()" style="font-size: 1.1em; padding: 5px 15px;">Print</button>
                <button onclick="window.close()" style="font-size: 1.1em; padding: 5px 15px;">Close</button>
            </div>
            
            <!-- View Mode Selection -->
            <div style="margin-bottom: 15px;">
                <label style="margin-right: 20px;">
                    <input type="radio" name="viewMode" value="list" onchange="toggleViewMode()" checked> List View
                </label>
                <label>
                    <input type="radio" name="viewMode" value="buttonGrid" onchange="toggleViewMode()"> 4x4 Button Grid
                </label>
            </div>

            <!-- List View Controls -->
            <div id="listViewControls">
                <label class="checkbox-group" style="font-weight: bold; color: #0066cc;">
                    <input type="checkbox" id="cb-grid" onchange="toggleGrid()"> Compact List Grid (2 per page)
                </label>
                <hr>
                <div>
                    <strong>Columns:</strong>
                    <label class="checkbox-group"><input type="checkbox" checked onchange="toggle('channel')" id="cb-channel"> Track</label>
                    <label class="checkbox-group"><input type="checkbox" checked onchange="toggle('btn')" id="cb-btn"> Button</label>
                    <label class="checkbox-group"><input type="checkbox" checked onchange="toggle('desc')" id="cb-desc"> Description</label>
                    <label class="checkbox-group"><input type="checkbox" checked onchange="toggle('cat')" id="cb-cat"> Category</label>
                    <label class="checkbox-group"><input type="checkbox" checked onchange="toggle('hint')" id="cb-hint"> Hint</label>
                    <label class="checkbox-group"><input type="checkbox" checked onchange="toggle('file')" id="cb-file"> Filename</label>
                </div>
            </div>
            
            <!-- Button Grid Controls -->
            <div id="buttonGridControls" style="display: none;">
                <strong>Grid Content:</strong>
                <select id="gridContentSelect" onchange="updateGridContent()">
                    <option value="description">Description</option>
                    <option value="category">Category</option>
                    <option value="hint">Hint</option>
                    <option value="filename">Filename</option>
                </select>
            </div>
        </div>
    </div>

    <div id="profiles-container">
        {% for item in items %}
        <div class="key-container {% if not loop.last %}page-break{% endif %}">
            <h1>Answer Key: {{ item.profile.name }} {% if item.profile.channel_number %}(Track {{ item.profile.channel_number }}){% endif %}</h1>
            {% if item.profile.instructions %}
            <div style="margin-bottom: 10px; font-style: italic; background: #f9f9f9; padding: 5px; border-left: 4px solid #ccc; font-size: 0.9em;">
                <strong>Instructions:</strong> {{ item.profile.instructions }}
            </div>
            {% endif %}
            
            <!-- List View Table -->
            <table class="keyTable list-view-el">
                <thead>
                    <tr>
                        <th class="col-channel">Track</th>
                        <th class="col-btn" width="50">Button</th>
                        <th class="col-desc">Description</th>
                        <th class="col-cat">Category</th>
                        <th class="col-hint">Hint</th>
                        <th class="col-file">Filename</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in item.rows %}
                    <tr>
                        <td class="col-channel">{{ item.profile.channel_number or '-' }}</td>
                        <td class="col-btn">{{ r.button_id }}</td>
                        <td class="col-desc">{{ r.description or '' }}</td>
                        <td class="col-cat">{{ r.category or '' }}</td>
                        <td class="col-hint">{{ r.hint or '' }}</td>
                        <td class="col-file">{{ r.filename }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 4x4 Button Grid View -->
            <div class="button-grid-container button-grid-view-el" style="display: none;">
                {% for i in range(1, 17) %}
                {% set row = item.map.get(i) %}
                <div class="button-cell">
                    <div class="button-number">{{ i }}</div>
                    <div class="button-content content-description">
                        {{ row.description if row else '-' }}
                    </div>
                    <div class="button-content content-category" style="display:none;">
                        {{ row.category if row else '-' }}
                    </div>
                    <div class="button-content content-hint" style="display:none;">
                        {{ row.hint if row else '-' }}
                    </div>
                    <div class="button-content content-filename" style="display:none;">
                        {{ row.filename if row else '-' }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        function toggleViewMode() {
            const mode = document.querySelector('input[name="viewMode"]:checked').value;
            const isList = mode === 'list';
            
            document.getElementById('listViewControls').style.display = isList ? 'block' : 'none';
            document.getElementById('buttonGridControls').style.display = isList ? 'none' : 'block';
            
            document.querySelectorAll('.list-view-el').forEach(el => el.style.display = isList ? '' : 'none');
            document.querySelectorAll('.button-grid-view-el').forEach(el => el.style.display = isList ? 'none' : 'grid');
            
            localStorage.setItem('print_key_view_mode', mode);
        }

        function updateGridContent() {
            const content = document.getElementById('gridContentSelect').value;
            // Hide all content divs
            document.querySelectorAll('.button-content').forEach(el => el.style.display = 'none');
            // Show selected
            document.querySelectorAll('.content-' + content).forEach(el => el.style.display = 'block');
            
            localStorage.setItem('print_key_grid_content', content);
        }

        function toggleGrid() {
            const isGrid = document.getElementById('cb-grid').checked;
            const container = document.getElementById('profiles-container');
            if (isGrid) {
                container.classList.add('grid-view');
            } else {
                container.classList.remove('grid-view');
            }
            localStorage.setItem('print_key_grid', isGrid);
        }

        function toggle(colName) {
            const show = document.getElementById('cb-' + colName).checked;
            const cells = document.querySelectorAll('.col-' + colName);
            cells.forEach(c => c.style.display = show ? '' : 'none');
            
            // Save preference
            localStorage.setItem('print_key_col_' + colName, show);
        }

        // Load preferences
        window.onload = function() {
            // Load View Mode
            const viewMode = localStorage.getItem('print_key_view_mode');
            if (viewMode) {
                const radio = document.querySelector(`input[name="viewMode"][value="${viewMode}"]`);
                if (radio) {
                    radio.checked = true;
                    toggleViewMode();
                }
            }
            
            // Load Grid Content
            const gridContent = localStorage.getItem('print_key_grid_content');
            if (gridContent) {
                document.getElementById('gridContentSelect').value = gridContent;
                updateGridContent();
            }

            // Load Compact Grid Preference
            const gridStored = localStorage.getItem('print_key_grid');
            if (gridStored !== null) {
                const isGrid = gridStored === 'true';
                document.getElementById('cb-grid').checked = isGrid;
                if (isGrid) {
                    document.getElementById('profiles-container').classList.add('grid-view');
                }
            }

            const cols = ['channel', 'btn', 'desc', 'cat', 'hint', 'file'];
            cols.forEach(c => {
                const stored = localStorage.getItem('print_key_col_' + c);
                if (stored !== null) {
                    const shouldShow = stored === 'true';
                    document.getElementById('cb-' + c).checked = shouldShow;
                    // Apply initial state
                    const cells = document.querySelectorAll('.col-' + c);
                    cells.forEach(cell => cell.style.display = shouldShow ? '' : 'none');
                }
            });
        }
    </script>
</body>
</html>
